#!/bin/bash

REGION=$(cc-read-vendordata "region")
if [ "${REGION}" = "KVM@TACC" ]; then
  exit 0
fi

NODE_ID=$(cc-read-vendordata "node")
BLAZAR_NODE_ID=$(openstack reservation host show ${NODE_ID} -f json 2>/dev/null | jq -r .id)
RESERVATION_INFO=$(openstack reservation host allocation show ${BLAZAR_NODE_ID} -f json 2>/dev/null)

LEASE_ID=$(echo "$RESERVATION_INFO" | jq -r '.reservations | fromjson | .lease_id')
START_DATE=$(echo "$RESERVATION_INFO" | jq -r '.reservations | fromjson | .start_date')
END_DATE=$(echo "$RESERVATION_INFO" | jq -r '.reservations | fromjson | .end_date')

END_SECONDS=$(date -d "${END_DATE%.*}" +%s)
NOW_SECONDS=$(date +%s)
DURATION=$((END_SECONDS - NOW_SECONDS))
DURATION_DAYS=$((DURATION / 86400))
DURATION_HOURS=$(( (DURATION % 86400) / 3600 ))

cat << EOF

LEASE INFORMATION

    Lease ID: ${LEASE_ID}
    Lease start: ${START_DATE}
    Lease end: ${END_DATE}

    Lease expires in ${DURATION_DAYS} days and ${DURATION_HOURS} hours

EOF
